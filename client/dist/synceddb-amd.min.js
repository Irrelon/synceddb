define(function(){function n(n){var e={};n=n||this,n.on=function(n,t,o){(e[n]=e[n]||[]).push({f:t,c:o})},n.off=function(n,t){n||(e={});for(var o=e[n]||[],r=o.length=t?o.length:0;r-->0;)t==o[r].f&&o.splice(r,1)},n.emit=function(){for(var n,t=Array.apply([],arguments),o=e[t.shift()]||[],r=0;n=o[r++];)n.f.apply(n.c,t)}}function e(n){return[].slice.call(n)}function t(n,e){Object.keys(n).forEach(function(t){e(t,n[t])})}function o(n){return JSON.parse(JSON.stringify(n))}function r(n){return delete n.remoteOriginal,delete n.version,delete n.changedSinceSync,n}function i(){return Function.bind.apply(arguments[0],arguments)}function c(n){return null!==n&&"object"==typeof n}function s(n){return"string"==typeof n}function a(n){return"number"==typeof n}function u(n){return"function"==typeof n}function f(n){return void 0===n}function d(n){return s(n)||a(n)}function h(n){if(n=d(n)?n:c(n)&&d(n.key)?n.key:void 0,f(n))throw new TypeError(n+" is not a valid key");return n}function l(n){this.val=n||0}function p(n){this._thenCbs=[],this._catchCbs=[],n(this._resolve.bind(this),this._reject.bind(this))}function m(e,t){var o=this;n(o);var r=this.ws=new WebSocket(e,t);r.onopen=function(){console.log("Connection open"),o.emit("open")},r.onerror=function(n){console.log("Connection errror"),console.log(n),o.emit("error",n)},r.onclose=function(n){console.log("Connection closed"),console.log(n),o.emit("close",n)},r.onmessage=function(n){console.log("Message recieved");var e;e=s(n.data)?JSON.parse(n.data):n.data,console.log(e),o.emit("message",e)}}function y(n,e,t,o){var r=[],c=n.store.IDBStore.index(n.name),s=new l(e.length);s.onZero=i(o,r),e.forEach(function(n){var e=c.openCursor(n);e.onsuccess=function(){var n=e.result;n?(r.push(n.value),n.continue()):s.add(-1)}})}function g(n,e){n.tx=e,n.IDBStore=e.objectStore(n.name),e.addEventListener("complete",function(){n.tx=void 0,b(n.changedRecords,n.db.stores[n.name]),n.changedRecords.length=0})}function v(n,e,t){return new p(function(o,r){var i=n.get(e);i.onsuccess=function(){f(i.result)||i.result.deleted&&!t?r({type:"KeyNotFoundError",key:e}):o(i.result)}})}function S(n,e,t){return e.tx?new p(function(n,o){t(e.tx,n,o)}):e.db.then(function(){var o=e.db.db.transaction(e.name,n);return g(e,o),new Promise(function(n,e){var r;t(o,function(n){r=n},e),o.oncomplete=function(){n(r)}})})}function w(n,e){return e.changedSinceSync=1,new p(function(t){f(e.key)?(e.key=Math.random().toString(36),V(n,e,"LOCAL").then(t)):v(n.IDBStore,e.key).then(function(i){e.version=i.version,0===i.changedSinceSync&&(e.remoteOriginal=r(o(i))),Z(n,e,"LOCAL").then(t)})})}function b(n,e){n.forEach(function(n){e.emit(n.type,{record:n.record,origin:n.origin}),e.db.continuousSync&&"REMOTE"!==n.origin&&E(e.db.ws,e.name,n.record)})}function N(n,e,t,o){var r=e.IDBStore;return new p(function(i){var c=r[n](t);c.onsuccess=function(){var r="add"===n?"add":"update";"INTERNAL"!==o&&e.changedRecords.push({type:r,origin:o,record:t}),i(c.result)}})}function k(n,e,t){var i=n.IDBStore;return new p(function(c){v(i,e,!0).then(function(i){var s={version:i.version,key:i.key,changedSinceSync:1,deleted:!0,remoteOriginal:i.remoteOriginal||r(o(i))};if(n.changedRecords.push({type:"delete",origin:t,record:s}),1===i.changedSinceSync&&!i.remoteOriginal||"REMOTE"===t){var a=n.IDBStore.delete(e);a.onsuccess=c}else Z(n,s,"INTERNAL").then(c)})})}function O(n,e,t,o){for(;o++<t;)u(e[o])&&e[o](n.db,n.e)}function E(n,e,t){var o=t.deleted?U:t.remoteOriginal?Q:H;n.send(o(e,t))}function R(n,e,t){n.get(e+"Meta").then(function(e){e.syncedTo=t,Z(n,e,"INTERNAL")})}function D(n,e,t){n.sdbMetaData.get(t+"Meta").then(function(n){e.send({type:"get-changes",storeName:t,since:n.syncedTo})})}function C(n,e,t){return n.write(e,"sdbMetaData",t).then(function(){n.changesLeftFromRemote.add(-1)})}function I(n,e){var t=X[e.type];t?t(n,n.ws,e):n.messages.emit(e.type,e)}function T(n){return new Promise(function(e){n.db.changesLeftFromRemote.onZero=i(e,n),n.storeNames.map(i(D,n.db,n.db.ws))})}function M(n){return new Promise(function(e){n.db.recordsToSync.onZero=i(e,n),G(n.db,n.storeNames).then(function(e){n.db.recordsToSync.add(e.length),e.forEach(function(e){E(n.db.ws,e.storeName,e.record)})})})}function B(n){return n.wsPromise||(n.wsPromise=new Promise(function(e){n.ws=new m("ws://"+n.remote),n.ws.on("message",i(I,n)),n.ws.on("open",function(){e(n.ws)})})),n.wsPromise}function L(n,t){if(n.syncing)return Promise.reject({type:"AlreadySyncing"});n.syncing=!0;var o=t.length?e(t):Object.keys(n.stores);return B(n).then(function(){return{db:n,storeNames:o}})}function j(n){n.db.syncing=!1,n.db.disconnect()}function A(n,e,t){return L(n,t).then(T).then(M).then(function(t){e?n.continuousSync=!0:j(t)})}var P={},_=Object,x=_.keys;P.diff=function Y(n,e){for(var t=x(n).sort(),o=x(e).sort(),r={},i={},c={},s=[],a={},u=0,f=0;t[u]||o[f];){var d=t[u],h=String.fromCharCode(u+48),l=o[f],p=n[d],m=e[l];if(d==l){if(_(p)===p&&_(m)===m){var y=Y(p,m);x(y)[0]&&(a[h]=y)}else p!==m&&(c[h]=m);u++,f++}else d>l||!d?(i[l]=m,f++):(s.push(h),u++)}return s[0]&&(r.d=s),x(i)[0]&&(r.a=i),x(c)[0]&&(r.m=c),x(a)[0]&&(r.r=a),r},P.patch=function $(n,e){var t,o,r,i,c=x(n).sort();for(t in e)for(o in e[t])r=e[t][o],i=c[("d"!=t?o:r).charCodeAt()-48],"a"==t?n[o]=r:"m"==t?n[i]=r:"d"==t?delete n[i]:$(n[i],r)};var F=function(n){n.target.close()};l.prototype.add=function(n){this.val+=n,0===this.val&&this.onZero()},p.prototype._resolve=function(n){var e=this;n&&u(n.then)?n.then(this._resolve.bind(this)):(e.val=n,this._thenCbs.forEach(function(e){e(n)}))},p.prototype._reject=function(n){this._catchCbs.forEach(function(e){e(n)})},p.prototype.then=function(n){var e=this;return new p(function(t,o){"val"in e?t(u(n)?n(e.val):e.val):(e._thenCbs.push(function(e){t(u(n)?n(e):e)}),e._catchCbs.push(function(n){o(n)}))})},p.prototype.catch=function(n){this._catchCbs.push(n)},p.all=function(n){return new p(function(e,t){var o=[],r=0;n.forEach(function(i,c){i.then(function(t){o[c]=t,++r===n.length&&e(o)}),i.catch(t)})})},m.prototype.send=function(n){this.ws.send(c(n)?JSON.stringify(n):n)},m.prototype.close=function(){this.ws.close.apply(this.ws,arguments)};var J=function(n,e,t){this.name=n,this.db=e,this.store=t};J.prototype.get=function(){var n=this,t=e(arguments).map(IDBKeyRange.only);return S("readonly",n.store,function(e,o,r){return y(n,t,e,o,r)})},J.prototype.getAll=function(){var n=this;return S("readonly",n.store,function(e,t,o){return y(n,[void 0],e,t,o)})},J.prototype.inRange=function(){var n=this,t=e(arguments).map(W);return S("readonly",n.store,function(e,o,r){return y(n,t,e,o,r)})};var K=function(e,t,o,r){var i=this;i.name=t,i.db=e,i.indexes=o,i.changedRecords=[],n(i),o.forEach(function(n){i[n]=new J(n,e,i)}),r&&g(i,r)};K.prototype.get=function(){var n=this,t=e(arguments);return S("readonly",n,function(e,o,r){var c=t.map(i(v,n.IDBStore));p.all(c).then(function(n){t.length===n.length&&o(1==t.length?n[0]:n)}).catch(function(n){r(n)})})},K.prototype.delete=function(){var n=this,t=e(arguments);return S("readwrite",n,function(e,o){var r=t.map(h),i=new l(r.length);i.onZero=o,r.forEach(function(e){k(n,e,"LOCAL").then(function(){i.add(-1)})})})},K.prototype.put=function(){var n=e(arguments),t=this;return S("readwrite",t,function(e,o){var r=n.map(i(w,t));p.all(r).then(o)})};var Z=i(N,"put"),V=i(N,"add"),W=function(n){var e="gt"in n,t="gte"in n,o="lt"in n,r="lte"in n,i=e?n.gt:n.gte,c=o?n.lt:n.lte;return e||t?o||r?IDBKeyRange.bound(i,c,e,o):IDBKeyRange.lowerBound(i,e):IDBKeyRange.upperBound(c,o)},q=function(n,e,o,r){var i,c=r.target,s=c.result,a=s.objectStoreNames;a.contains("sdbMetaData")?i=c.transaction.objectStore("sdbMetaData"):(i=s.createObjectStore("sdbMetaData",{keyPath:"key"}),i.put({key:"meta"})),t(e,function(n,e){var t;a.contains(n)?t=c.transaction.objectStore(n):(t=s.createObjectStore(n,{keyPath:"key"}),i.put({key:n+"Meta",syncedTo:null})),e.forEach(function(n){t.indexNames.contains(n[0])||t.createIndex.apply(t,n)})}),o&&O({db:s,e:r},o,n,r.oldVersion)},z=function(e){var o=this;n(o),o.name=e.name,o.remote=e.remote,o.version=e.version,o.recordsToSync=new l,o.changesLeftFromRemote=new l,o.messages=new n,o.stores={};var r={};return t(e.stores,function(n,e){r[n]=e.concat([["changedSinceSync","changedSinceSync"]])}),t(r,function(n,e){var t=e.map(function(n){return n[0]}),r=new K(o,n,t);o.stores[n]=r,o[n]=o[n]||r}),o.sdbMetaData=new K(o,"sdbMetaData",[]),this.promise=new Promise(function(n){var t=indexedDB.open(o.name,o.version);t.onupgradeneeded=i(q,o.version,r,e.migrations),t.onsuccess=function(e){o.db=t.result,o.db.onversionchange=F,n({db:o,e:e})}}),o};z.prototype.then=function(n){return this.promise.then(n)},z.prototype.catch=function(n){return this.promise.catch(n)},z.prototype.transaction=function(n,e,t){n=[].concat(n),e="r"===e?"readonly":"read"===e?"readonly":"rw"===e?"readwrite":e;var o=this;return new Promise(function(r){o.then(function(){var i=o.db.transaction(n,e),c=n.map(function(n){var e="sdbMetaData"===n?o[n]:o.stores[n];return new K(o,n,e.indexes,i)});i.oncomplete=r,t.apply(null,c)})})},z.prototype.read=function(){var n=e(arguments),t=n.pop();return this.transaction(n,"r",t)},z.prototype.write=function(){var n=e(arguments),t=n.pop();return this.transaction(n,"rw",t)};var G=function(n,t){var o=[];return n.transaction(t,"r",function(){var n=e(arguments);n.forEach(function(n){n.changedSinceSync.get(1).then(function(e){e.forEach(function(e){o.push({record:e,storeName:n.name})})})})}).then(function(){return o})},H=function(n,e){return r(e),JSON.stringify({type:"create",storeName:n,record:e})},Q=function(n,e){var t=e.remoteOriginal;delete e.remoteOriginal,t.version=e.version,t.changedSinceSync=1;var o=P.diff(t,e);return e.remoteOriginal=t,JSON.stringify({type:"update",storeName:n,version:e.version,diff:o,key:e.key})},U=function(n,e){return JSON.stringify({type:"delete",storeName:n,key:e.key,version:e.version})},X={"sending-changes":function(n,e,t){n.emit("sync-initiated",t),n.changesLeftFromRemote.add(t.nrOfRecordsToSync)},create:function(n,e,t){t.record.changedSinceSync=0,C(n,t.storeName,function(n,e){V(n,t.record,"REMOTE").then(function(){R(e,t.storeName,t.timestamp)})})},update:function(n,e,t){C(n,t.storeName,function(e,i){v(e.IDBStore,t.key,!0).then(function(i){if(1===i.changedSinceSync){var c=i.remoteOriginal,s=r(i),a=o(c);P.patch(a,t.diff);var u=n.stores[t.storeName].handleConflict(c,s,a);return Z(e,u,"LOCAL")}return P.patch(i,t.diff),Z(e,i,"REMOTE")}).then(function(){R(i,t.storeName,t.timestamp)})})},"delete":function(n,e,t){C(n,t.storeName,function(e,o){v(e.IDBStore,t.key,!0).then(function(o){if(1!==o.changedSinceSync||o.deleted)k(e,t.key,"REMOTE");else{var i=o.remoteOriginal,c=r(o),s={deleted:!0,key:t.key},a=n.stores[t.storeName].handleConflict(i,c,s);a.deleted?k(e,t.key,"REMOTE"):Z(e,a,"LOCAL")}}).then(function(){R(o,t.storeName,t.timestamp)})})},ok:function(n,e,t){var o;n.write(t.storeName,"sdbMetaData",function(n,e){v(n.IDBStore,t.key,!0).then(function(e){o=e,o.deleted?n.IDBStore.delete(t.key):(o.changedSinceSync=0,o.version=t.newVersion,delete o.remoteOriginal,f(t.newKey)||(o.key=t.newKey,n.IDBStore.delete(t.key)),Z(n,o,"INTERNAL"))}).then(function(){R(e,t.storeName,t.timestamp)})}).then(function(){n.stores[t.storeName].emit("synced",t.key,o),n.recordsToSync.add(-1)})},reject:function(n,e,t){var o=n.stores[t.storeName].handleReject;if(!u(o))throw new Error("Reject message recieved from remote but no reject handler is supplied");n.stores[t.storeName].get(t.key).then(function(n){return o(n,t)}).then(function(o){o?E(e,t.storeName,o):n.recordsToSync.add(-1)})}};return z.prototype.connect=function(){var n=this;return n.then(function(){return B(n).then(function(){})})},z.prototype.disconnect=function(){this.ws&&(this.ws.close(),this.wsPromise=null)},z.prototype.send=function(n){return B(this).then(function(e){e.send(n)})},z.prototype.pushToRemote=function(){return L(this,arguments).then(M).then(j)},z.prototype.pullFromRemote=function(){return L(this,arguments).then(T).then(j)},z.prototype.sync=function(){return A(this,!1,arguments)},z.prototype.syncContinuously=function(){return A(this,!0,arguments)},P.open=function(n){return new z(n)},P});