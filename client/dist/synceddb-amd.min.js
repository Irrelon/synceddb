define(function(){function n(n){return n&&"function"==typeof n.then}function t(t){function c(n,t){if(i.a=f,i.v=n,i.s=t,t===u&&!i.c[t].length)throw n;i.c[t].forEach(function(t){t(n)}),i.c=null}function o(t){i.c&&(n(t)?t.then(o).catch(h):c(t,e))}function h(t){i.c&&(n(t)?t.then(h).catch(h):c(t,u))}var i=this;i.v=0,i.s=r,i.c=[[],[]],i.a=!1;var f=!0;t(o,h),f=!1}var c={},o=Object,r=(o.keys,2),e=0,u=1,h=t.prototype;return h.then=function(n){var c=this;if(c.a)throw new Error("Can not call then on synchonously resolved promise");return new t(function(t,o){function r(){try{t(n(c.v))}catch(r){o(r)}}c.s===e?r():c.s===u?o(c.v):(c.c[e].push(r),c.c[u].push(o))})},h.catch=function(n){var c=this;if(c.a)throw new Error("Can not call catch on synchonously resolved promise");return new t(function(t,o){function r(){try{t(n(c.v))}catch(r){o(r)}}c.s===u?r():c.s===e?t(c.v):(c.c[u].push(r),c.c[e].push(t))})},t.all=function(c){return new t(function(t,o,r){r=c.length,c.forEach(function(e,u){n(e)?e.then(function(n){c[u]=n,--r||t(c)}).catch(o):--r||t(c)})})},c});