define(function(){function e(e){return e&&"function"==typeof e.then}function n(n){function t(e,n){i.v=e,i.s=n,i.c[n].forEach(function(n){n(e)}),i.c=null}function o(n){i.c&&(e(n)?(n.then(o),n.catch(r)):t(n,V))}function r(n){i.c&&(e(n)?(n.then(r),n.catch(r)):t(n,W))}var i=this;i.v=0,i.s=Z,i.c=[[],[]];try{n(o,r)}catch(c){r(c)}}function t(e){var n={};e=e||this,e.on=function(e,t,o){(n[e]=n[e]||[]).push({f:t,c:o})},e.off=function(e,t){e||(n={});for(var o=n[e]||[],r=o.length=t?o.length:0;r-->0;)t==o[r].f&&o.splice(r,1)},e.emit=function(){for(var e,t=Array.apply([],arguments),o=n[t.shift()]||[],r=0;e=o[r++];)e.f.apply(e.c,t)}}function o(e){return[].slice.call(e)}function r(e,n){Object.keys(e).forEach(function(t){n(t,e[t])})}function i(e){return JSON.parse(JSON.stringify(e))}function c(e){return delete e.remoteOriginal,delete e.version,delete e.changedSinceSync,e}function a(){return Function.bind.apply(arguments[0],arguments)}function s(e){return null!==e&&"object"==typeof e}function u(e){return"string"==typeof e}function f(e){return"number"==typeof e}function d(e){return"function"==typeof e}function h(e){return void 0===e}function m(e){return u(e)||f(e)}function y(e){if(e=m(e)?e:s(e)&&m(e.key)?e.key:void 0,h(e))throw new TypeError(e+" is not a valid key");return e}function l(e){this.val=e||0}function p(e,n){var o=this;t(o);var r=this.ws=new WebSocket(e,n);r.onopen=function(){console.log("Connection open"),o.emit("open")},r.onerror=function(e){console.log("Connection errror"),console.log(e),o.emit("error",e)},r.onclose=function(e){console.log("Connection closed"),console.log(e),o.emit("close",e)},r.onmessage=function(e){console.log("Message recieved");var n;n=u(e.data)?JSON.parse(e.data):e.data,console.log(n),o.emit("message",n)}}function g(e,n,t,o){var r=[],i=e.store.IDBStore.index(e.name),c=new l(n.length);c.onZero=a(o,r),n.forEach(function(e){var n=i.openCursor(e);n.onsuccess=function(){var e=n.result;e?(r.push(e.value),e.continue()):c.add(-1)}})}function v(e,n){e.tx=n,e.IDBStore=n.objectStore(e.name),n.addEventListener("abort",function(){e.tx=void 0}),n.addEventListener("complete",function(){e.tx=void 0,N(e.changedRecords,e.db.stores[e.name]),e.changedRecords.length=0})}function w(e,t,o){return new n(function(n,r){var i=e.get(t);i.onsuccess=function(){h(i.result)||i.result.deleted&&!o?r({type:"KeyNotFoundError",key:t}):n(i.result)}})}function S(e,t,o){return t.tx?new n(function(e,n){o(t.tx,e,n)}):t.db.then(function(){var n=t.db.db.transaction(t.name,e);return v(t,n),new Promise(function(e,t){var r,i;o(n,function(e){r=e,i=!1},function(e){r=e,i=!0}),n.oncomplete=function(){i?t(r):e(r)}})})}function b(e,t){return t.changedSinceSync=1,new n(function(n){h(t.key)?(t.key=Math.random().toString(36),U(e,t,"LOCAL").then(n)):w(e.IDBStore,t.key).then(function(o){t.version=o.version,0===o.changedSinceSync&&(t.remoteOriginal=c(i(o))),Q(e,t,"LOCAL").then(n)})})}function N(e,n){e.forEach(function(e){n.emit(e.type,{record:e.record,origin:e.origin}),n.db.continuousSync&&"REMOTE"!==e.origin&&R(n.db.ws,n.name,e.record)})}function k(e,t,o,r){var i=t.IDBStore;return new n(function(n){var c=i[e](o);c.onsuccess=function(){var i="add"===e?"add":"update";"INTERNAL"!==r&&t.changedRecords.push({type:i,origin:r,record:o}),n(c.result)}})}function O(e,t,o){var r=e.IDBStore;return new n(function(n){w(r,t,!0).then(function(r){var a={version:r.version,key:r.key,changedSinceSync:1,deleted:!0,remoteOriginal:r.remoteOriginal||c(i(r))};if(e.changedRecords.push({type:"delete",origin:o,record:a}),1===r.changedSinceSync&&!r.remoteOriginal||"REMOTE"===o){var s=e.IDBStore.delete(t);s.onsuccess=n}else Q(e,a,"INTERNAL").then(n)})})}function E(e,n,t,o){for(;o++<t;)d(n[o])&&n[o](e.db,e.e)}function R(e,n,t){var o=t.deleted?tn:t.remoteOriginal?nn:en;e.send(o(n,t))}function D(e,n,t){e.get(n+"Meta").then(function(n){n.syncedTo=t,Q(e,n,"INTERNAL")})}function I(e,n,t){e.sdbMetaData.get(t+"Meta").then(function(e){n.send({type:"get-changes",storeName:t,since:e.syncedTo})})}function T(e,n,t){return e.write(n,"sdbMetaData",t).then(function(){e.changesLeftFromRemote.add(-1)})}function L(e,n){var t=on[n.type],o=u(n.storeName)?e.stores[n.storeName].messages:e.messages;d(t)?t(e,e.ws,n):o.emit(n.type,n)}function M(e){return new Promise(function(n){e.db.changesLeftFromRemote.onZero=a(n,e),e.storeNames.map(a(I,e.db,e.db.ws))})}function B(e){return new Promise(function(n){e.db.recordsToSync.onZero=a(n,e),_(e.db,e.storeNames).then(function(n){e.db.recordsToSync.add(n.length),n.forEach(function(n){R(e.db.ws,n.storeName,n.record)})})})}function j(e){return e.wsPromise||(e.wsPromise=new Promise(function(n){e.ws=new p("ws://"+e.remote),e.ws.on("message",a(L,e)),e.ws.on("open",function(){n(e.ws)})})),e.wsPromise}function C(e,n){if(e.syncing)return Promise.reject({type:"AlreadySyncing"});e.syncing=!0;var t=n.length?o(n):Object.keys(e.stores);return j(e).then(function(){return{db:e,storeNames:t}})}function A(e){e.db.syncing=!1,e.db.disconnect()}function P(e,n,t){return C(e,t).then(M).then(B).then(function(t){n?e.continuousSync=!0:A(t)})}var x={},F=Object,J=F.keys,K={diff:function rn(e,n){for(var t=J(e).sort(),o=J(n).sort(),r={},i={},c={},a=[],s={},u=0,f=0;t[u]||o[f];){var d=t[u],h=String.fromCharCode(u+48),m=o[f],y=e[d],l=n[m];if(d==m){if(F(y)===y&&F(l)===l){var p=rn(y,l);J(p)[0]&&(s[h]=p)}else y!==l&&(c[h]=l);u++,f++}else d>m||!d?(i[m]=l,f++):(a.push(h),u++)}return a[0]&&(r.d=a),J(i)[0]&&(r.a=i),J(c)[0]&&(r.m=c),J(s)[0]&&(r.r=s),r},patch:function cn(e,n){var t,o,r,i,c=J(e).sort();for(t in n)for(o in n[t])r=n[t][o],i=c[("d"!=t?o:r).charCodeAt()-48],"a"==t?e[o]=r:"m"==t?e[i]=r:"d"==t?delete e[i]:cn(e[i],r)}},Z=3,V=0,W=1;n.resolve=function(t){return e(t)?t:new n(function(e){e(t)})},n.reject=function(t){return e(t)?t:new n(function(e,n){n(t)})};var q=n.prototype;q.then=function(e){var t=this;return new n(function(n,o){function r(){try{n(e(t.v))}catch(r){o(r)}}t.s===V?r():t.s===W?o(t.v):(t.c[V].push(r),t.c[W].push(o))})},q.catch=function(e){var t=this;return new n(function(n,o){function r(){try{n(e(t.v))}catch(r){o(r)}}t.s===W?r():t.s===V?n(t.v):(t.c[W].push(r),t.c[V].push(n))})},n.all=function(t){return new n(function(n,o,r){r=t.length,t.forEach(function(i,c){e(i)?i.then(function(e){t[c]=e,--r||n(t)}).catch(o):--r||n(t)})})};var z=function(e){e.target.close()};l.prototype.add=function(e){this.val+=e,0===this.val&&this.onZero()},p.prototype.send=function(e){this.ws.send(s(e)?JSON.stringify(e):e)},p.prototype.close=function(){this.ws.close.apply(this.ws,arguments)};var G=function(e,n,t){this.name=e,this.db=n,this.store=t};G.prototype.get=function(){var e=this,n=o(arguments).map(IDBKeyRange.only);return S("readonly",e.store,function(t,o,r){return g(e,n,t,o,r)})},G.prototype.getAll=function(){var e=this;return S("readonly",e.store,function(n,t,o){return g(e,[void 0],n,t,o)})},G.prototype.inRange=function(){var e=this,n=o(arguments).map(X);return S("readonly",e.store,function(t,o,r){return g(e,n,t,o,r)})};var H=function(e,n,o,r){var i=this;i.name=n,i.db=e,i.indexes=o,i.changedRecords=[],i.messages=new t,t(i),o.forEach(function(n){i[n]=new G(n,e,i)}),r&&v(i,r)};H.prototype.get=function(){var e=this,t=o(arguments);return S("readonly",e,function(o,r,i){var c=t.map(a(w,e.IDBStore));n.all(c).then(function(e){t.length===e.length&&r(1==t.length?e[0]:e)}).catch(function(e){i(e)})})},H.prototype.delete=function(){var e=this,t=o(arguments);return S("readwrite",e,function(o,r,i){var c=t.map(function(n){return O(e,y(n),"LOCAL")});n.all(c).then(r).catch(i)})},H.prototype.put=function(){var e=o(arguments),t=this;return S("readwrite",t,function(o,r){var i=e.map(a(b,t));n.all(i).then(r)})};var Q=a(k,"put"),U=a(k,"add"),X=function(e){var n="gt"in e,t="gte"in e,o="lt"in e,r="lte"in e,i=n?e.gt:e.gte,c=o?e.lt:e.lte;return n||t?o||r?IDBKeyRange.bound(i,c,n,o):IDBKeyRange.lowerBound(i,n):IDBKeyRange.upperBound(c,o)},Y=function(e,n,t,o){var i,c=o.target,a=c.result,s=a.objectStoreNames;s.contains("sdbMetaData")?i=c.transaction.objectStore("sdbMetaData"):(i=a.createObjectStore("sdbMetaData",{keyPath:"key"}),i.put({key:"meta"})),r(n,function(e,n){var t;s.contains(e)?t=c.transaction.objectStore(e):(t=a.createObjectStore(e,{keyPath:"key"}),i.put({key:e+"Meta",syncedTo:null})),n.forEach(function(e){t.indexNames.contains(e[0])||t.createIndex.apply(t,e)})}),t&&E({db:a,e:o},t,e,o.oldVersion)},$=function(e){var n=this;t(n),n.name=e.name,n.remote=e.remote,n.version=e.version,n.recordsToSync=new l,n.changesLeftFromRemote=new l,n.messages=new t,n.stores={};var o={};return r(e.stores,function(e,n){o[e]=n.concat([["changedSinceSync","changedSinceSync"]])}),r(o,function(e,t){var o=t.map(function(e){return e[0]}),r=new H(n,e,o);n.stores[e]=r,n[e]=n[e]||r}),n.sdbMetaData=new H(n,"sdbMetaData",[]),this.promise=new Promise(function(t){var r=indexedDB.open(n.name,n.version);r.onupgradeneeded=a(Y,n.version,o,e.migrations),r.onsuccess=function(e){n.db=r.result,n.db.onversionchange=z,t({db:n,e:e})}}),n};$.prototype.then=function(e){return this.promise.then(e)},$.prototype.catch=function(e){return this.promise.catch(e)},$.prototype.transaction=function(e,n,t){e=[].concat(e),n="r"===n?"readonly":"read"===n?"readonly":"rw"===n?"readwrite":n;var o=this;return new Promise(function(r){o.then(function(){var i=o.db.transaction(e,n),c=e.map(function(e){var n="sdbMetaData"===e?o[e]:o.stores[e];return new H(o,e,n.indexes,i)});i.oncomplete=r,t.apply(null,c)})})},$.prototype.read=function(){var e=o(arguments),n=e.pop();return this.transaction(e,"r",n)},$.prototype.write=function(){var e=o(arguments),n=e.pop();return this.transaction(e,"rw",n)};var _=function(e,n){var t=[];return e.transaction(n,"r",function(){var e=o(arguments);e.forEach(function(e){e.changedSinceSync.get(1).then(function(n){n.forEach(function(n){t.push({record:n,storeName:e.name})})})})}).then(function(){return t})},en=function(e,n){return c(n),JSON.stringify({type:"create",storeName:e,record:n})},nn=function(e,n){var t=n.remoteOriginal;delete n.remoteOriginal,t.version=n.version,t.changedSinceSync=1;var o=K.diff(t,n);return n.remoteOriginal=t,JSON.stringify({type:"update",storeName:e,version:n.version,diff:o,key:n.key})},tn=function(e,n){return JSON.stringify({type:"delete",storeName:e,key:n.key,version:n.version})},on={"sending-changes":function(e,n,t){e.emit("sync-initiated",t),e.changesLeftFromRemote.add(t.nrOfRecordsToSync)},create:function(e,n,t){t.record.changedSinceSync=0,T(e,t.storeName,function(e,n){U(e,t.record,"REMOTE").then(function(){D(n,t.storeName,t.timestamp)})})},update:function(e,n,t){T(e,t.storeName,function(n,o){w(n.IDBStore,t.key,!0).then(function(o){if(1===o.changedSinceSync){var r=o.remoteOriginal,a=c(o),s=i(r);K.patch(s,t.diff);var u=e.stores[t.storeName].handleConflict(r,a,s);return Q(n,u,"LOCAL")}return K.patch(o,t.diff),Q(n,o,"REMOTE")}).then(function(){D(o,t.storeName,t.timestamp)})})},"delete":function(e,n,t){T(e,t.storeName,function(n,o){w(n.IDBStore,t.key,!0).then(function(o){if(1!==o.changedSinceSync||o.deleted)O(n,t.key,"REMOTE");else{var r=o.remoteOriginal,i=c(o),a={deleted:!0,key:t.key},s=e.stores[t.storeName].handleConflict(r,i,a);s.deleted?O(n,t.key,"REMOTE"):Q(n,s,"LOCAL")}}).then(function(){D(o,t.storeName,t.timestamp)})})},ok:function(e,n,t){var o;e.write(t.storeName,"sdbMetaData",function(e,n){w(e.IDBStore,t.key,!0).then(function(n){o=n,o.deleted?e.IDBStore.delete(t.key):(o.changedSinceSync=0,o.version=t.newVersion,delete o.remoteOriginal,h(t.newKey)||(o.key=t.newKey,e.IDBStore.delete(t.key)),Q(e,o,"INTERNAL"))}).then(function(){D(n,t.storeName,t.timestamp)})}).then(function(){e.stores[t.storeName].emit("synced",t.key,o),e.recordsToSync.add(-1)})},reject:function(e,n,t){if(!m(t.key))throw new Error("Reject message recieved from remote without key property");var o=u(t.storeName)?e.stores[t.storeName].handleReject:e.handleReject;if(!d(o))throw new Error("Reject message recieved from remote but no reject handler is supplied");e.stores[t.storeName].get(t.key).then(function(e){return o(e,t)}).then(function(o){o?R(n,t.storeName,o):e.recordsToSync.add(-1)})}};return $.prototype.connect=function(){var e=this;return e.then(function(){return j(e).then(function(){})})},$.prototype.disconnect=function(){this.ws&&(this.ws.close(),this.wsPromise=null)},$.prototype.send=function(e){return j(this).then(function(n){n.send(e)})},$.prototype.pushToRemote=function(){return C(this,arguments).then(B).then(A)},$.prototype.pullFromRemote=function(){return C(this,arguments).then(M).then(A)},$.prototype.sync=function(){return P(this,!1,arguments)},$.prototype.syncContinuously=function(){return P(this,!0,arguments)},x.open=function(e){return new $(e)},x});