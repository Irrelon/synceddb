!function(n){function e(n){var e={};n=n||this,n.on=function(n,t,o){(e[n]=e[n]||[]).push({f:t,c:o})},n.off=function(n,t){n||(e={});for(var o=e[n]||[],r=o.length=t?o.length:0;r-->0;)t==o[r].f&&o.splice(r,1)},n.emit=function(){for(var n,t=Array.apply([],arguments),o=e[t.shift()]||[],r=0;n=o[r++];)n.f.apply(n.c,t)}}function t(n){return[].slice.call(n)}function o(n,e){Object.keys(n).forEach(function(t){e(t,n[t])})}function r(n){return JSON.parse(JSON.stringify(n))}function i(n){return delete n.remoteOriginal,delete n.version,delete n.changedSinceSync,n}function c(){return Function.bind.apply(arguments[0],arguments)}function s(n){return null!==n&&"object"==typeof n}function a(n){return"string"==typeof n}function u(n){return"number"==typeof n}function f(n){return"function"==typeof n}function d(n){return void 0===n}function h(n){return a(n)||u(n)}function l(n){if(n=h(n)?n:s(n)&&h(n.key)?n.key:void 0,d(n))throw new TypeError(n+" is not a valid key");return n}function p(n){this.val=n||0}function y(n){this._thenCbs=[],this._catchCbs=[],n(this._resolve.bind(this),this._reject.bind(this))}function m(n,t){var o=this;e(o);var r=this.ws=new WebSocket(n,t);r.onopen=function(){console.log("Connection open"),o.emit("open")},r.onerror=function(n){console.log("Connection errror"),console.log(n),o.emit("error",n)},r.onclose=function(n){console.log("Connection closed"),console.log(n),o.emit("close",n)},r.onmessage=function(n){console.log("Message recieved");var e;e=a(n.data)?JSON.parse(n.data):n.data,console.log(e),o.emit("message",e)}}function g(n,e,t,o){var r=[],i=n.store.IDBStore.index(n.name),s=new p(e.length);s.onZero=c(o,r),e.forEach(function(n){var e=i.openCursor(n);e.onsuccess=function(){var n=e.result;n?(r.push(n.value),n.continue()):s.add(-1)}})}function v(n,e){n.tx=e,n.IDBStore=e.objectStore(n.name),e.addEventListener("complete",function(){n.tx=void 0,N(n.changedRecords,n.db.stores[n.name]),n.changedRecords.length=0})}function S(n,e,t){return new y(function(o,r){var i=n.get(e);i.onsuccess=function(){d(i.result)||i.result.deleted&&!t?r({type:"KeyNotFoundError",key:e}):o(i.result)}})}function w(n,e,t){return e.tx?new y(function(n,o){t(e.tx,n,o)}):e.db.then(function(){var o=e.db.db.transaction(e.name,n);return v(e,o),new Promise(function(n,e){var r;t(o,function(n){r=n},e),o.oncomplete=function(){n(r)}})})}function b(n,e){return e.changedSinceSync=1,new y(function(t){d(e.key)?(e.key=Math.random().toString(36),V(n,e,"LOCAL").then(t)):S(n.IDBStore,e.key).then(function(o){e.version=o.version,0===o.changedSinceSync&&(e.remoteOriginal=i(r(o))),Z(n,e,"LOCAL").then(t)})})}function N(n,e){n.forEach(function(n){e.emit(n.type,{record:n.record,origin:n.origin}),e.db.continuousSync&&"REMOTE"!==n.origin&&R(e.db.ws,e.name,n.record)})}function k(n,e,t,o){var r=e.IDBStore;return new y(function(i){var c=r[n](t);c.onsuccess=function(){var r="add"===n?"add":"update";"INTERNAL"!==o&&e.changedRecords.push({type:r,origin:o,record:t}),i(c.result)}})}function O(n,e,t){var o=n.IDBStore;return new y(function(c){S(o,e,!0).then(function(o){var s={version:o.version,key:o.key,changedSinceSync:1,deleted:!0,remoteOriginal:o.remoteOriginal||i(r(o))};if(n.changedRecords.push({type:"delete",origin:t,record:s}),1===o.changedSinceSync&&!o.remoteOriginal||"REMOTE"===t){var a=n.IDBStore.delete(e);a.onsuccess=c}else Z(n,s,"INTERNAL").then(c)})})}function E(n,e,t,o){for(;o++<t;)f(e[o])&&e[o](n.db,n.e)}function R(n,e,t){var o=t.deleted?U:t.remoteOriginal?Q:H;n.send(o(e,t))}function D(n,e,t){n.get(e+"Meta").then(function(e){e.syncedTo=t,Z(n,e,"INTERNAL")})}function C(n,e,t){n.sdbMetaData.get(t+"Meta").then(function(n){e.send({type:"get-changes",storeName:t,since:n.syncedTo})})}function I(n,e,t){return n.write(e,"sdbMetaData",t).then(function(){n.changesLeftFromRemote.add(-1)})}function T(n,e,t){var o=X[t.type];o?o(n,e,t):n.messages.emit(t.type,t)}function B(n){return new Promise(function(e){n.db.changesLeftFromRemote.onZero=c(e,n),n.storeNames.map(c(C,n.db,n.db.ws))})}function L(n){return new Promise(function(e){n.db.recordsToSync.onZero=c(e,n),G(n.db,n.storeNames).then(function(e){n.db.recordsToSync.add(e.length),e.forEach(function(e){R(n.db.ws,e.storeName,e.record)})})})}function M(n){return n.wsPromise||(n.wsPromise=new Promise(function(e){n.ws=new m("ws://"+n.remote),n.ws.on("open",function(){e(n.ws)})})),n.wsPromise}function j(n,e){if(n.syncing)return Promise.reject({type:"AlreadySyncing"});n.syncing=!0;var o=e.length?t(e):Object.keys(n.stores);return M(n).then(function(e){return e.on("message",c(T,n,e)),{db:n,storeNames:o}})}function A(n){n.db.syncing=!1,n.db.disconnect()}function P(n,e,t){return j(n,t).then(B).then(L).then(function(t){e?n.continuousSync=!0:A(t)})}var _=Object,x=_.keys;n.diff=function Y(n,e){for(var t=x(n).sort(),o=x(e).sort(),r={},i={},c={},s=[],a={},u=0,f=0;t[u]||o[f];){var d=t[u],h=String.fromCharCode(u+48),l=o[f],p=n[d],y=e[l];if(d==l){if(_(p)===p&&_(y)===y){var m=Y(p,y);x(m)[0]&&(a[h]=m)}else p!==y&&(c[h]=y);u++,f++}else d>l||!d?(i[l]=y,f++):(s.push(h),u++)}return s[0]&&(r.d=s),x(i)[0]&&(r.a=i),x(c)[0]&&(r.m=c),x(a)[0]&&(r.r=a),r},n.patch=function $(n,e){var t,o,r,i,c=x(n).sort();for(t in e)for(o in e[t])r=e[t][o],i=c[("d"!=t?o:r).charCodeAt()-48],"a"==t?n[o]=r:"m"==t?n[i]=r:"d"==t?delete n[i]:$(n[i],r)};var F=function(n){n.target.close()};p.prototype.add=function(n){this.val+=n,0===this.val&&this.onZero()},y.prototype._resolve=function(n){var e=this;n&&f(n.then)?n.then(this._resolve.bind(this)):(e.val=n,this._thenCbs.forEach(function(e){e(n)}))},y.prototype._reject=function(n){this._catchCbs.forEach(function(e){e(n)})},y.prototype.then=function(n){var e=this;return new y(function(t,o){"val"in e?t(f(n)?n(e.val):e.val):(e._thenCbs.push(function(e){t(f(n)?n(e):e)}),e._catchCbs.push(function(n){o(n)}))})},y.prototype.catch=function(n){this._catchCbs.push(n)},y.all=function(n){return new y(function(e,t){var o=[],r=0;n.forEach(function(i,c){i.then(function(t){o[c]=t,++r===n.length&&e(o)}),i.catch(t)})})},m.prototype.send=function(n){this.ws.send(s(n)?JSON.stringify(n):n)},m.prototype.close=function(){this.ws.close.apply(this.ws,arguments)};var J=function(n,e,t){this.name=n,this.db=e,this.store=t};J.prototype.get=function(){var n=this,e=t(arguments).map(IDBKeyRange.only);return w("readonly",n.store,function(t,o,r){return g(n,e,t,o,r)})},J.prototype.getAll=function(){var n=this;return w("readonly",n.store,function(e,t,o){return g(n,[void 0],e,t,o)})},J.prototype.inRange=function(){var n=this,e=t(arguments).map(W);return w("readonly",n.store,function(t,o,r){return g(n,e,t,o,r)})};var K=function(n,t,o,r){var i=this;i.name=t,i.db=n,i.indexes=o,i.changedRecords=[],e(i),o.forEach(function(e){i[e]=new J(e,n,i)}),r&&v(i,r)};K.prototype.get=function(){var n=this,e=t(arguments);return w("readonly",n,function(t,o,r){var i=e.map(c(S,n.IDBStore));y.all(i).then(function(n){e.length===n.length&&o(1==e.length?n[0]:n)}).catch(function(n){r(n)})})},K.prototype.delete=function(){var n=this,e=t(arguments);return w("readwrite",n,function(t,o){var r=e.map(l),i=new p(r.length);i.onZero=o,r.forEach(function(e){O(n,e,"LOCAL").then(function(){i.add(-1)})})})},K.prototype.put=function(){var n=t(arguments),e=this;return w("readwrite",e,function(t,o){var r=n.map(c(b,e));y.all(r).then(o)})};var Z=c(k,"put"),V=c(k,"add"),W=function(n){var e="gt"in n,t="gte"in n,o="lt"in n,r="lte"in n,i=e?n.gt:n.gte,c=o?n.lt:n.lte;return e||t?o||r?IDBKeyRange.bound(i,c,e,o):IDBKeyRange.lowerBound(i,e):IDBKeyRange.upperBound(c,o)},q=function(n,e,t,r){var i,c=r.target,s=c.result,a=s.objectStoreNames;a.contains("sdbMetaData")?i=c.transaction.objectStore("sdbMetaData"):(i=s.createObjectStore("sdbMetaData",{keyPath:"key"}),i.put({key:"meta"})),o(e,function(n,e){var t;a.contains(n)?t=c.transaction.objectStore(n):(t=s.createObjectStore(n,{keyPath:"key"}),i.put({key:n+"Meta",syncedTo:null})),e.forEach(function(n){t.indexNames.contains(n[0])||t.createIndex.apply(t,n)})}),t&&E({db:s,e:r},t,n,r.oldVersion)},z=function(n){var t=this;e(t),t.name=n.name,t.remote=n.remote,t.version=n.version,t.recordsToSync=new p,t.changesLeftFromRemote=new p,t.messages=new e,t.stores={};var r={};return o(n.stores,function(n,e){r[n]=e.concat([["changedSinceSync","changedSinceSync"]])}),o(r,function(n,e){var o=e.map(function(n){return n[0]}),r=new K(t,n,o);t.stores[n]=r,t[n]=t[n]||r}),t.sdbMetaData=new K(t,"sdbMetaData",[]),this.promise=new Promise(function(e){var o=indexedDB.open(t.name,t.version);o.onupgradeneeded=c(q,t.version,r,n.migrations),o.onsuccess=function(n){t.db=o.result,t.db.onversionchange=F,e({db:t,e:n})}}),t};z.prototype.then=function(n){return this.promise.then(n)},z.prototype.catch=function(n){return this.promise.catch(n)},z.prototype.transaction=function(n,e,t){n=[].concat(n),e="r"===e?"readonly":"read"===e?"readonly":"rw"===e?"readwrite":e;var o=this;return new Promise(function(r){o.then(function(){var i=o.db.transaction(n,e),c=n.map(function(n){return new K(o,n,o[n].indexes,i)});i.oncomplete=r,t.apply(null,c)})})},z.prototype.read=function(){var n=t(arguments),e=n.pop();return this.transaction(n,"r",e)},z.prototype.write=function(){var n=t(arguments),e=n.pop();return this.transaction(n,"rw",e)};var G=function(n,e){var o=[];return n.transaction(e,"r",function(){var n=t(arguments);n.forEach(function(n){n.changedSinceSync.get(1).then(function(e){e.forEach(function(e){o.push({record:e,storeName:n.name})})})})}).then(function(){return o})},H=function(n,e){return i(e),JSON.stringify({type:"create",storeName:n,record:e})},Q=function(e,t){var o=t.remoteOriginal;delete t.remoteOriginal,o.version=t.version,o.changedSinceSync=1;var r=n.diff(o,t);return t.remoteOriginal=o,JSON.stringify({type:"update",storeName:e,version:t.version,diff:r,key:t.key})},U=function(n,e){return JSON.stringify({type:"delete",storeName:n,key:e.key,version:e.version})},X={"sending-changes":function(n,e,t){n.emit("sync-initiated",t),n.changesLeftFromRemote.add(t.nrOfRecordsToSync)},create:function(n,e,t){t.record.changedSinceSync=0,I(n,t.storeName,function(n,e){V(n,t.record,"REMOTE").then(function(){D(e,t.storeName,t.timestamp)})})},update:function(e,t,o){I(e,o.storeName,function(t,c){S(t.IDBStore,o.key,!0).then(function(c){if(1===c.changedSinceSync){var s=c.remoteOriginal,a=i(c),u=r(s);n.patch(u,o.diff);var f=e.stores[o.storeName].handleConflict(s,a,u);return Z(t,f,"LOCAL")}return n.patch(c,o.diff),Z(t,c,"REMOTE")}).then(function(){D(c,o.storeName,o.timestamp)})})},"delete":function(n,e,t){I(n,t.storeName,function(e,o){S(e.IDBStore,t.key,!0).then(function(o){if(1!==o.changedSinceSync||o.deleted)O(e,t.key,"REMOTE");else{var r=o.remoteOriginal,c=i(o),s={deleted:!0,key:t.key},a=n.stores[t.storeName].handleConflict(r,c,s);a.deleted?O(e,t.key,"REMOTE"):Z(e,a,"LOCAL")}}).then(function(){D(o,t.storeName,t.timestamp)})})},ok:function(n,e,t){var o;n.write(t.storeName,"sdbMetaData",function(n,e){S(n.IDBStore,t.key,!0).then(function(e){o=e,o.deleted?n.IDBStore.delete(t.key):(o.changedSinceSync=0,o.version=t.newVersion,delete o.remoteOriginal,d(t.newKey)||(o.key=t.newKey,n.IDBStore.delete(t.key)),Z(n,o,"INTERNAL"))}).then(function(){D(e,t.storeName,t.timestamp)})}).then(function(){n.stores[t.storeName].emit("synced",t.key,o),n.recordsToSync.add(-1)})},reject:function(n,e,t){var o=n.stores[t.storeName].handleReject;if(!f(o))throw new Error("Reject message recieved from remote but no reject handler is supplied");n.stores[t.storeName].get(t.key).then(function(n){return o(n,t)}).then(function(o){o?R(e,t.storeName,o):n.recordsToSync.add(-1)})}};z.prototype.connect=function(){var n=this;return n.then(function(){return M(n).then(function(){})})},z.prototype.disconnect=function(){this.ws&&(this.ws.close(),this.wsPromise=null)},z.prototype.send=function(n){return M(this).then(function(e){e.send(n)})},z.prototype.pushToRemote=function(){return j(this,arguments).then(L).then(A)},z.prototype.pullFromRemote=function(){return j(this,arguments).then(B).then(A)},z.prototype.sync=function(){return P(this,!1,arguments)},z.prototype.syncContinuously=function(){return P(this,!0,arguments)},n.open=function(n){return new z(n)}}(this.syncedDB={});