!function(e){function n(e){var n={};e=e||this,e.on=function(e,t,o){(n[e]=n[e]||[]).push({f:t,c:o})},e.off=function(e,t){e||(n={});for(var o=n[e]||[],r=o.length=t?o.length:0;r-->0;)t==o[r].f&&o.splice(r,1)},e.emit=function(){for(var e,t=Array.apply([],arguments),o=n[t.shift()]||[],r=0;e=o[r++];)e.f.apply(e.c,t)}}function t(e){return[].slice.call(e)}function o(e,n){Object.keys(e).forEach(function(t){n(t,e[t])})}function r(e){return JSON.parse(JSON.stringify(e))}function i(e){return delete e.remoteOriginal,delete e.version,delete e.changedSinceSync,e}function c(){return Function.bind.apply(arguments[0],arguments)}function a(e){return null!==e&&"object"==typeof e}function s(e){return"string"==typeof e}function u(e){return"number"==typeof e}function f(e){return"function"==typeof e}function d(e){return void 0===e}function h(e){return s(e)||u(e)}function l(e){if(e=h(e)?e:a(e)&&h(e.key)?e.key:void 0,d(e))throw new TypeError(e+" is not a valid key");return e}function m(e){this.val=e||0}function y(e){this._thenCbs=[],this._catchCbs=[],e(this._resolve.bind(this),this._reject.bind(this))}function p(e,t){var o=this;n(o);var r=this.ws=new WebSocket(e,t);r.onopen=function(){console.log("Connection open"),o.emit("open")},r.onerror=function(e){console.log("Connection errror"),console.log(e),o.emit("error",e)},r.onclose=function(e){console.log("Connection closed"),console.log(e),o.emit("close",e)},r.onmessage=function(e){console.log("Message recieved");var n;n=s(e.data)?JSON.parse(e.data):e.data,console.log(n),o.emit("message",n)}}function g(e,n,t,o){var r=[],i=e.store.IDBStore.index(e.name),a=new m(n.length);a.onZero=c(o,r),n.forEach(function(e){var n=i.openCursor(e);n.onsuccess=function(){var e=n.result;e?(r.push(e.value),e.continue()):a.add(-1)}})}function v(e,n){e.tx=n,e.IDBStore=n.objectStore(e.name),n.addEventListener("complete",function(){e.tx=void 0,I(e.changedRecords,e.db.stores[e.name]),e.changedRecords.length=0})}function S(e,n,t){return new y(function(o,r){var i=e.get(n);i.onsuccess=function(){d(i.result)||i.result.deleted&&!t?r({type:"KeyNotFoundError",key:n}):o(i.result)}})}function b(e,n,t){return n.tx?new y(function(e,o){t(n.tx,e,o)}):n.db.then(function(){var o=n.db.db.transaction(n.name,e);return v(n,o),new Promise(function(e,n){var r;t(o,function(e){r=e},n),o.oncomplete=function(){e(r)}})})}function w(e,n){return n.changedSinceSync=1,new y(function(t){d(n.key)?(n.key=Math.random().toString(36),Z(e,n,"LOCAL").then(t)):S(e.IDBStore,n.key).then(function(o){n.version=o.version,0===o.changedSinceSync&&(n.remoteOriginal=i(r(o))),K(e,n,"LOCAL").then(t)})})}function I(e,n){e.forEach(function(e){n.emit(e.type,{record:e.record,origin:e.origin}),n.db.continuousWs&&"REMOTE"!==e.origin&&E(n.db.continuousWs,n.name,n.db.clientId,e.record)})}function N(e,n,t,o){var r=n.IDBStore;return new y(function(i){var c=r[e](t);c.onsuccess=function(){var r="add"===e?"add":"update";"INTERNAL"!==o&&n.changedRecords.push({type:r,origin:o,record:t}),i(c.result)}})}function k(e,n,t){var o=e.IDBStore;return new y(function(c){S(o,n,!0).then(function(o){var a={version:o.version,key:o.key,changedSinceSync:1,deleted:!0,remoteOriginal:o.remoteOriginal||i(r(o))};if(e.changedRecords.push({type:"delete",origin:t,record:a}),1===o.changedSinceSync&&!o.remoteOriginal||"REMOTE"===t){var s=e.IDBStore.delete(n);s.onsuccess=c}else K(e,a,"INTERNAL").then(c)})})}function O(e,n,t,o){for(;o++<t;)f(n[o])&&n[o](e.db,e.e)}function E(e,n,t,o){var r=o.deleted?Q:o.remoteOriginal?H:G;e.send(r(n,t,o))}function R(e,n,t){e.get(n+"Meta").then(function(n){n.syncedTo=t,K(e,n,"INTERNAL")})}function D(e){return e.clientId?Promise.resolve(e.clientId):e.sdbMetaData.get("meta").then(function(n){return n.clientId?(e.clientId=n.clientId,n.clientId):(n.clientId=Math.random().toString(36),e.write("sdbMetaData",function(e){K(e,n,"INTERNAL")}).then(function(){return e.clientId=n.clientId,n.clientId}))})}function C(e,n,t,o){e.sdbMetaData.get(o+"Meta").then(function(e){n.send({type:"get-changes",storeName:o,clientId:t,since:e.syncedTo})})}function T(e,n,t){e.write(n,"sdbMetaData",t).then(function(){e.changesLeftFromRemote.add(-1)})}function M(e,n,t){var o=U[t.type];o?o(e,n,t):e.messages.emit(t.type,t)}function B(e){return new Promise(function(n){e.db.changesLeftFromRemote.onZero=c(n,e),e.storeNames.map(c(C,e.db,e.ws,e.clientId))})}function L(e){return new Promise(function(n){e.db.recordsToSync.onZero=c(n,e),z(e.db,e.storeNames).then(function(n){e.db.recordsToSync.add(n.length),n.forEach(function(n){E(e.ws,n.storeName,e.clientId,n.record)})})})}function j(e,n){if(e.syncing)return Promise.reject({type:"AlreadySyncing"});e.syncing=!0;var o=n.length?t(n):Object.keys(e.stores);return D(e).then(function(n){return new Promise(function(t){var r=new p("ws://"+e.remote);r.on("message",c(M,e,r)),r.on("open",function(){t({db:e,storeNames:o,clientId:n,ws:r})})})})}function A(e){e.db.syncing=!1,e.ws.close()}var _=Object,x=_.keys;e.diff=function X(e,n){for(var t=x(e).sort(),o=x(n).sort(),r={},i={},c={},a=[],s={},u=0,f=0;t[u]||o[f];){var d=t[u],h=String.fromCharCode(u+48),l=o[f],m=e[d],y=n[l];if(d==l){if(_(m)===m&&_(y)===y){var p=X(m,y);x(p)[0]&&(s[h]=p)}else m!==y&&(c[h]=y);u++,f++}else d>l||!d?(i[l]=y,f++):(a.push(h),u++)}return a[0]&&(r.d=a),x(i)[0]&&(r.a=i),x(c)[0]&&(r.m=c),x(s)[0]&&(r.r=s),r},e.patch=function Y(e,n){var t,o,r,i,c=x(e).sort();for(t in n)for(o in n[t])r=n[t][o],i=c[("d"!=t?o:r).charCodeAt()-48],"a"==t?e[o]=r:"m"==t?e[i]=r:"d"==t?delete e[i]:Y(e[i],r)};var P=function(e){e.target.close()};m.prototype.add=function(e){this.val+=e,0===this.val&&this.onZero()},y.prototype._resolve=function(e){var n=this;e&&f(e.then)?e.then(this._resolve.bind(this)):(n.val=e,this._thenCbs.forEach(function(n){n(e)}))},y.prototype._reject=function(e){this._catchCbs.forEach(function(n){n(e)})},y.prototype.then=function(e){var n=this;return new y(function(t,o){"val"in n?t(f(e)?e(n.val):n.val):(n._thenCbs.push(function(n){t(f(e)?e(n):n)}),n._catchCbs.push(function(e){o(e)}))})},y.prototype.catch=function(e){this._catchCbs.push(e)},y.all=function(e){return new y(function(n,t){var o=[],r=0;e.forEach(function(i,c){i.then(function(t){o[c]=t,++r===e.length&&n(o)}),i.catch(t)})})},p.prototype.send=function(e){this.ws.send(a(e)?JSON.stringify(e):e)},p.prototype.close=function(){this.ws.close.apply(this.ws,arguments)};var F=function(e,n,t){this.name=e,this.db=n,this.store=t};F.prototype.get=function(){var e=this,n=t(arguments).map(IDBKeyRange.only);return b("readonly",e.store,function(t,o,r){return g(e,n,t,o,r)})},F.prototype.getAll=function(){var e=this;return b("readonly",e.store,function(n,t,o){return g(e,[void 0],n,t,o)})},F.prototype.inRange=function(){var e=this,n=t(arguments).map(W);return b("readonly",e.store,function(t,o,r){return g(e,n,t,o,r)})};var J=function(e,t,o,r){var i=this;i.name=t,i.db=e,i.indexes=o,i.changedRecords=[],n(i),o.forEach(function(n){i[n]=new F(n,e,i)}),r&&v(i,r)};J.prototype.get=function(){var e=this,n=t(arguments);return b("readonly",e,function(t,o,r){var i=n.map(c(S,e.IDBStore));y.all(i).then(function(e){n.length===e.length&&o(1==n.length?e[0]:e)}).catch(function(e){r(e)})})},J.prototype.delete=function(){var e=this,n=t(arguments);return b("readwrite",e,function(t,o){var r=n.map(l),i=new m(r.length);i.onZero=o,r.forEach(function(n){k(e,n,"LOCAL").then(function(){i.add(-1)})})})},J.prototype.put=function(){var e=t(arguments),n=this;return b("readwrite",n,function(t,o){var r=e.map(c(w,n));y.all(r).then(o)})};var K=c(N,"put"),Z=c(N,"add"),W=function(e){var n="gt"in e,t="gte"in e,o="lt"in e,r="lte"in e,i=n?e.gt:e.gte,c=o?e.lt:e.lte;return n||t?o||r?IDBKeyRange.bound(i,c,n,o):IDBKeyRange.lowerBound(i,n):IDBKeyRange.upperBound(c,o)},V=function(e,n,t,r){var i,c=r.target,a=c.result,s=a.objectStoreNames;s.contains("sdbMetaData")?i=c.transaction.objectStore("sdbMetaData"):(i=a.createObjectStore("sdbMetaData",{keyPath:"key"}),i.put({key:"meta",clientId:void 0})),o(n,function(e,n){var t;s.contains(e)?t=c.transaction.objectStore(e):(t=a.createObjectStore(e,{keyPath:"key"}),i.put({key:e+"Meta",syncedTo:null})),n.forEach(function(e){t.indexNames.contains(e[0])||t.createIndex.apply(t,e)})}),t&&O({db:a,e:r},t,e,r.oldVersion)},q=function(e){var t=this;n(t),t.name=e.name,t.remote=e.remote,t.version=e.version,t.recordsToSync=new m,t.changesLeftFromRemote=new m,t.messages=new n,t.stores={};var r={};return o(e.stores,function(e,n){r[e]=n.concat([["changedSinceSync","changedSinceSync"]])}),o(r,function(e,n){var o=n.map(function(e){return e[0]}),r=new J(t,e,o);t.stores[e]=r,t[e]=t[e]||r}),t.sdbMetaData=new J(t,"sdbMetaData",[]),this.promise=new Promise(function(n){var o=indexedDB.open(t.name,t.version);o.onupgradeneeded=c(V,t.version,r,e.migrations),o.onsuccess=function(e){t.db=o.result,t.db.onversionchange=P,n({db:t,e:e})}}),t};q.prototype.then=function(e){return this.promise.then(e)},q.prototype.catch=function(e){return this.promise.catch(e)},q.prototype.transaction=function(e,n,t){e=[].concat(e),n="r"===n?"readonly":"read"===n?"readonly":"rw"===n?"readwrite":n;var o=this;return new Promise(function(r){o.then(function(){var i=o.db.transaction(e,n),c=e.map(function(e){return new J(o,e,o[e].indexes,i)});i.oncomplete=r,t.apply(null,c)})})},q.prototype.read=function(){var e=t(arguments),n=e.pop();return this.transaction(e,"r",n)},q.prototype.write=function(){var e=t(arguments),n=e.pop();return this.transaction(e,"rw",n)};var z=function(e,n){var o=[];return e.transaction(n,"r",function(){var e=t(arguments);e.forEach(function(e){e.changedSinceSync.get(1).then(function(n){n.forEach(function(n){o.push({record:n,storeName:e.name})})})})}).then(function(){return o})},G=function(e,n,t){return i(t),JSON.stringify({type:"create",storeName:e,clientId:n,record:t})},H=function(n,t,o){var r=o.remoteOriginal;delete o.remoteOriginal,r.version=o.version,r.changedSinceSync=1;var i=e.diff(r,o);return o.remoteOriginal=r,JSON.stringify({type:"update",storeName:n,clientId:t,version:o.version,diff:i,key:o.key})},Q=function(e,n,t){return JSON.stringify({type:"delete",storeName:e,key:t.key,version:t.version,clientId:n})},U={"sending-changes":function(e,n,t){e.emit("sync-initiated",t),e.changesLeftFromRemote.add(t.nrOfRecordsToSync)},create:function(e,n,t){t.record.changedSinceSync=0,T(e,t.storeName,function(e,n){Z(e,t.record,"REMOTE").then(function(){R(n,t.storeName,t.timestamp)})})},update:function(n,t,o){T(n,o.storeName,function(t,c){S(t.IDBStore,o.key,!0).then(function(c){if(1===c.changedSinceSync){var a=c.remoteOriginal,s=i(c),u=r(a);e.patch(u,o.diff);var f=n.stores[o.storeName].handleConflict(a,s,u);return K(t,f,"LOCAL")}return e.patch(c,o.diff),K(t,c,"REMOTE")}).then(function(){R(c,o.storeName,o.timestamp)})})},"delete":function(e,n,t){T(e,t.storeName,function(n,o){S(n.IDBStore,t.key,!0).then(function(o){if(1!==o.changedSinceSync||o.deleted)k(n,t.key,"REMOTE");else{var r=o.remoteOriginal,c=i(o),a={deleted:!0,key:t.key},s=e.stores[t.storeName].handleConflict(r,c,a);s.deleted?k(n,t.key,"REMOTE"):K(n,s,"LOCAL")}}).then(function(){R(o,t.storeName,t.timestamp)})})},ok:function(e,n,t){var o;return e.write(t.storeName,function(e){S(e.IDBStore,t.key,!0).then(function(n){o=n,o.deleted?e.IDBStore.delete(t.key):(o.changedSinceSync=0,o.version=t.newVersion,delete o.remoteOriginal,d(t.newKey)||(o.key=t.newKey,e.IDBStore.delete(t.key)),K(e,o,"INTERNAL"))})}).then(function(){e.stores[t.storeName].emit("synced",t.key,o),e.recordsToSync.add(-1)})},reject:function(e,n,t){var o=e.stores[t.storeName].handleReject;if(!f(o))throw new Error("Reject message recieved from remote but no reject handler is supplied");e.stores[t.storeName].get(t.key).then(function(e){return o(e,t)}).then(function(o){o?E(n,t.storeName,e.clientId,o):e.recordsToSync.add(-1)})}};q.prototype.pushToRemote=function(){return j(this,arguments).then(L).then(A)},q.prototype.pullFromRemote=function(){return j(this,arguments).then(B).then(A)},q.prototype.sync=function(){return j(this,arguments).then(B).then(L).then(A)},q.prototype.syncContinuously=function(){var e=this;return j(e,arguments).then(function(n){return e.continuousWs=n.ws,n}).then(B).then(L)},e.open=function(e){return new q(e)}}(this.syncedDB={});