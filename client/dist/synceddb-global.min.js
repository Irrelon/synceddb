!function(e){function n(e){return e&&"function"==typeof e.then}function t(e){function t(e,n){if(c.a=i,c.v=e,c.s=n,n===Q&&!c.c[n].length)throw e;c.c[n].forEach(function(n){n(e)}),c.c=null}function r(e){c.c&&(n(e)?e.then(r).catch(o):t(e,H))}function o(e){c.c&&(n(e)?e.then(o).catch(o):t(e,Q))}var c=this;c.v=0,c.s=G,c.c=[[],[]],c.a=!1;var i=!0;e(r,o),i=!1}function r(e){var n={};e=e||this,e.on=function(e,t,r){(n[e]=n[e]||[]).push({f:t,c:r})},e.off=function(e,t){e||(n={});for(var r=n[e]||[],o=r.length=t?r.length:0;o-->0;)t==r[o].f&&r.splice(o,1)},e.emit=function(){for(var e,t=Array.apply([],arguments),r=n[t.shift()]||[],o=0;e=r[o++];)e.f.apply(e.c,t)}}function o(e){return[].slice.call(e)}function c(e,n){Object.keys(e).forEach(function(t){n(t,e[t])})}function i(){return Function.bind.apply(arguments[0],arguments)}function a(e){return null!==e&&"object"==typeof e}function s(e){return"string"==typeof e}function u(e){return"number"==typeof e}function f(e){return"function"==typeof e}function d(e){return void 0===e}function h(e){return s(e)||u(e)}function l(e){return JSON.parse(JSON.stringify(e))}function m(e){this.val=e||0}function y(e,n){var t=this;r(t);var o=this.ws=new WebSocket(e,n);o.onopen=function(){console.log("Connection open"),t.emit("open")},o.onerror=function(e){console.log("Connection errror"),console.log(e),t.emit("error",e)},o.onclose=function(e){console.log("Connection closed"),console.log(e),t.emit("close",e)},o.onmessage=function(e){console.log("Message recieved");var n;n=s(e.data)?JSON.parse(e.data):e.data,console.log(n),t.emit("message",n)}}function p(e){var n=l(e);return delete n.remoteOriginal,delete n.version,delete n.changedSinceSync,n}function g(e){var n=a(e)?e.key:e;if(!h(n))throw new TypeError(n+" is not a valid key");return n}function v(e){e.target.close()}function S(e,n,t,r){var o=[],c=e.store.IDBStore.index(e.name),a=new m(n.length);a.onZero=i(r,o),n.forEach(function(e){var n=c.openCursor(e);n.onsuccess=function(){var e=n.result;e?(o.push(e.value),e.continue()):a.add(-1)}})}function w(e,n){e.forEach(function(e){n.emit(e.type,{record:e.record,origin:e.origin}),n.db.continuousSync&&"REMOTE"!==e.origin&&B(n.db,n.name,e.record)})}function b(e,n){e.tx=n,e.IDBStore=n.objectStore(e.name),n.addEventListener("abort",function(){e.tx=void 0}),n.addEventListener("complete",function(){e.tx=void 0,w(e.changedRecords,e.db.stores[e.name]),e.changedRecords.length=0})}function k(e,n,r){return new t(function(t,o){var c=e.get(n);c.onsuccess=function(){d(c.result)||c.result.deleted&&!r?o({type:"KeyNotFoundError",key:n}):t(c.result)}})}function N(e,n,r){return n.tx?new t(function(e,t){r(n.tx,e,t)}):n.db.then(function(){var t=n.db.db.transaction(n.name,e);return b(n,t),new Promise(function(e,n){var o,c;r(t,function(e){o=e,c=!1},function(e){o=e,c=!0}),t.oncomplete=function(){c?n(o):e(o)}})})}function R(e,n){return k(e.IDBStore,n.key).then(function(e){n.version=e.version,0===e.changedSinceSync&&(n.remoteOriginal=p(e))})}function O(e,n){var r=n.rec;return new t(function(t){n.newRec?en(e,r,"LOCAL").then(t):R(e,r).then(function(){return _(e,r,"LOCAL")}).then(t)})}function E(e,n,r,o){if("LOCAL"===o){var c=n.db.recordsSentToRemote[r.key];void 0!==c&&(c.changedSince=!0)}var i=n.IDBStore;return new t(function(t){var c=i[e](r);c.onsuccess=function(){var i="add"===e?"add":"update";"INTERNAL"!==o&&n.changedRecords.push({type:i,origin:o,record:r}),t(c.result)}})}function T(e){return{version:e.version,key:e.key,changedSinceSync:1,deleted:!0,remoteOriginal:e.remoteOriginal||p(e)}}function D(e,n,r){if("LOCAL"===r){var o=e.db.recordsSentToRemote[n];void 0!==o&&(o.changedSince=!0)}var c=e.IDBStore;return new t(function(t){k(c,n,!0).then(function(o){var c=T(o);if(e.changedRecords.push({type:"delete",origin:r,record:c}),1===o.changedSinceSync&&!o.remoteOriginal||"REMOTE"===r){var i=e.IDBStore.delete(n);i.onsuccess=t}else _(e,c,"INTERNAL").then(t)})})}function L(e){var n="gt"in e,t="gte"in e,r="lt"in e,o="lte"in e,c=n?e.gt:e.gte,i=r?e.lt:e.lte;return n||t?r||o?IDBKeyRange.bound(c,i,n,r):IDBKeyRange.lowerBound(c,n):IDBKeyRange.upperBound(i,r)}function I(e,n,t,r){for(;r++<t;)f(n[r])&&n[r](e.db,e.e)}function B(e,n,t){var r=t.deleted?cn:t.remoteOriginal?on:rn;e.recordsSentToRemote[t.key]={changedSince:!1,record:l(t)},e.ws.send(r(n,t))}function M(e,n,t){e.get(n+"Meta").then(function(n){n.syncedTo=t,_(e,n,"INTERNAL")})}function A(e,n,t){e.sdbMetaData.get(t+"Meta").then(function(e){n.send({type:"get-changes",storeName:t,since:e.syncedTo})})}function C(e,n,t){return e.write(n,"sdbMetaData",t).then(function(){e.changesLeftFromRemote.add(-1)})}function j(e,n){var t=an[n.type],r=s(n.storeName)?e.stores[n.storeName].messages:e.messages;f(t)?t(e,e.ws,n):r.emit(n.type,n)}function P(e){return new Promise(function(n){e.db.changesLeftFromRemote.onZero=i(n,e),e.storeNames.map(i(A,e.db,e.db.ws))})}function x(e){return e.db.transaction(e.storeNames,"r",function(){var n=o(arguments),r=n.map(function(e){return e.changedSinceSync.get(1)});t.all(r).then(function(t){var r=t.reduce(function(t,r,o){return r.forEach(i(B,e.db,n[o].name)),t+r.length},0);e.db.recordsToSync.add(r)})})}function F(e){return new Promise(function(n){e.db.recordsToSync.onZero=i(n,e),x(e)})}function K(e){return e.wsPromise||(e.wsPromise=new Promise(function(n){e.ws=new y("ws://"+e.remote),e.ws.on("message",i(j,e)),e.ws.on("open",function(){n(e.ws)})})),e.wsPromise}function J(e,n){if(e.syncing)return Promise.reject({type:"AlreadySyncing"});e.syncing=!0;var t=n.length?o(n):Object.keys(e.stores);return e.then(function(){return K(e)}).then(function(){return{db:e,storeNames:t}})}function Z(e){e.db.syncing=!1,e.db.disconnect()}function V(e,n,t){return J(e,t).then(P).then(F).then(function(t){n?e.continuousSync=!0:Z(t)})}var W=Object,q=W.keys,z={diff:function sn(e,n){for(var t=q(e).sort(),r=q(n).sort(),o={},c={},i={},a=[],s={},u=0,f=0;t[u]||r[f];){var d=t[u],h=String.fromCharCode(u+48),l=r[f],m=e[d],y=n[l];if(d==l){if(W(m)===m&&W(y)===y){var p=sn(m,y);q(p)[0]&&(s[h]=p)}else m!==y&&(i[h]=y);u++,f++}else d>l||!d?(c[l]=y,f++):(a.push(h),u++)}return a[0]&&(o.d=a),q(c)[0]&&(o.a=c),q(i)[0]&&(o.m=i),q(s)[0]&&(o.r=s),o},patch:function un(e,n){var t,r,o,c,i=q(e).sort();for(t in n)for(r in n[t])o=n[t][r],c=i[("d"!=t?r:o).charCodeAt()-48],"a"==t?e[r]=o:"m"==t?e[c]=o:"d"==t?delete e[c]:un(e[c],o)}},G=2,H=0,Q=1,U=t.prototype;U.then=function(e){var n=this;if(n.a)throw new Error("Can not call then on synchonously resolved promise");return new t(function(t,r){function o(){try{t(e(n.v))}catch(o){r(o)}}n.s===H?o():n.s===Q?r(n.v):(n.c[H].push(o),n.c[Q].push(r))})},U.catch=function(e){var n=this;if(n.a)throw new Error("Can not call catch on synchonously resolved promise");return new t(function(t,r){function o(){try{t(e(n.v))}catch(o){r(o)}}n.s===Q?o():n.s===H?t(n.v):(n.c[Q].push(o),n.c[H].push(t))})},t.all=function(e){return new t(function(t,r,o){o=e.length,e.forEach(function(c,i){n(c)?c.then(function(n){e[i]=n,--o||t(e)}).catch(r):--o||t(e)})})};var X=Array.isArray;m.prototype.add=function(e){this.val+=e,0===this.val&&this.onZero()},y.prototype.send=function(e){this.ws.send(a(e)?JSON.stringify(e):e)},y.prototype.close=function(){this.ws.close.apply(this.ws,arguments)};var Y=function(e,n,t){this.name=e,this.db=n,this.store=t};Y.prototype.get=function(){var e=this,n=o(arguments).map(IDBKeyRange.only);return N("readonly",e.store,function(t,r,o){return S(e,n,t,r,o)})},Y.prototype.getAll=function(){var e=this;return N("readonly",e.store,function(n,t,r){return S(e,[void 0],n,t,r)})},Y.prototype.inRange=function(){var e=this,n=o(arguments).map(L);return N("readonly",e.store,function(t,r,o){return S(e,n,t,r,o)})};var $=function(e,n,t,o){var c=this;c.name=n,c.db=e,c.indexes=t,c.changedRecords=[],c.messages=new r,r(c),t.forEach(function(n){c[n]=new Y(n,e,c)}),o&&b(c,o)};$.prototype.get=function(){var e=this,n=o(arguments);return N("readonly",e,function(r,o,c){var a=n.map(i(k,e.IDBStore));t.all(a).then(function(e){n.length===e.length&&o(1==n.length?e[0]:e)}).catch(c)})},$.prototype.delete=function(){var e=this,n=o(arguments);return N("readwrite",e,function(r,o,c){var i=n.map(function(n){return D(e,g(n),"LOCAL")});t.all(i).then(o).catch(c)})},$.prototype.put=function(){var e=o(arguments),n=this,r=e.map(function(e){var n;return d(e.key)?(n=!0,e.key=Math.random().toString(36)):n=!1,e.changedSinceSync=1,{newRec:n,rec:e}});return N("readwrite",n,function(e,o){var c=r.map(i(O,n));t.all(c).then(o)})};var _=i(E,"put"),en=i(E,"add"),nn=function(e,n,t,r){var o,i=r.target,a=i.result,s=a.objectStoreNames;s.contains("sdbMetaData")?o=i.transaction.objectStore("sdbMetaData"):(o=a.createObjectStore("sdbMetaData",{keyPath:"key"}),o.put({key:"meta"})),c(n,function(e,n){var t;s.contains(e)?t=i.transaction.objectStore(e):(t=a.createObjectStore(e,{keyPath:"key"}),o.put({key:e+"Meta",syncedTo:null})),n.forEach(function(e){t.indexNames.contains(e[0])||t.createIndex.apply(t,e)})}),t&&I({db:a,e:r},t,e,r.oldVersion)},tn=function(e){var n=this;r(n),n.name=e.name,n.remote=e.remote,n.version=e.version,n.recordsToSync=new m,n.changesLeftFromRemote=new m,n.messages=new r,n.recordsSentToRemote={},n.stores={};var t={};return c(e.stores,function(e,n){t[e]=n.concat([["changedSinceSync","changedSinceSync"]])}),c(t,function(e,t){var r=t.map(function(e){return e[0]}),o=new $(n,e,r);n.stores[e]=o,n[e]=n[e]||o}),n.sdbMetaData=new $(n,"sdbMetaData",[]),this.promise=new Promise(function(r){var o=indexedDB.open(n.name,n.version);o.onupgradeneeded=i(nn,n.version,t,e.migrations),o.onsuccess=function(e){n.db=o.result,n.db.onversionchange=v,r({db:n,e:e})}}),n};tn.prototype.then=function(e){return this.promise.then(e)},tn.prototype.catch=function(e){return this.promise.catch(e)},tn.prototype.transaction=function(e,n,t){e=[].concat(e),n="r"===n?"readonly":"read"===n?"readonly":"rw"===n?"readwrite":n;var r=this;return r.then(function(){return new Promise(function(o){var c=r.db.transaction(e,n),i=e.map(function(e){var n="sdbMetaData"===e?r[e]:r.stores[e];return new $(r,e,n.indexes,c)});c.oncomplete=o,t.apply(null,i)})})},tn.prototype.read=function(){var e=o(arguments),n=e.pop();return this.transaction(e,"r",n)},tn.prototype.write=function(){var e=o(arguments),n=e.pop();return this.transaction(e,"rw",n)};var rn=function(e,n){var t=p(n);return delete t.key,{type:"create",storeName:e,record:t,key:n.key}},on=function(e,n){var t=n.remoteOriginal;delete n.remoteOriginal,t.version=n.version,t.changedSinceSync=1;var r=z.diff(t,n);return n.remoteOriginal=t,{type:"update",storeName:e,version:n.version,diff:r,key:n.key}},cn=function(e,n){return{type:"delete",storeName:e,key:n.key,version:n.version}},an={"sending-changes":function(e,n,t){e.emit("sync-initiated",t),e.changesLeftFromRemote.add(t.nrOfRecordsToSync)},create:function(e,n,t){t.record.changedSinceSync=0,t.record.key=t.key,t.record.version=t.version,C(e,t.storeName,function(e,n){en(e,t.record,"REMOTE").then(function(){M(n,t.storeName,t.timestamp)})})},update:function(e,n,t){C(e,t.storeName,function(n,r){k(n.IDBStore,t.key,!0).then(function(r){if(1===r.changedSinceSync){var o=r.remoteOriginal,c=l(o);c.version=r.version,c.changedSinceSync=1,z.patch(c,t.diff),r.remoteOriginal=c;var i=e.stores[t.storeName].handleConflict(o,r,c);return _(n,i,"LOCAL")}return z.patch(r,t.diff),r.version=t.version,_(n,r,"REMOTE")}).then(function(){M(r,t.storeName,t.timestamp)})})},"delete":function(e,n,t){C(e,t.storeName,function(n,r){k(n.IDBStore,t.key,!0).then(function(r){if(1!==r.changedSinceSync||r.deleted)D(n,t.key,"REMOTE");else{var o=r.remoteOriginal,c={deleted:!0,key:t.key};r.remoteOriginal=c;var i=e.stores[t.storeName].handleConflict(o,r,c);i.deleted?D(n,t.key,"REMOTE"):_(n,i,"LOCAL")}}).then(function(){M(r,t.storeName,t.timestamp)})})},ok:function(e,n,t){var r,o=e.recordsSentToRemote[t.key];e.write(t.storeName,"sdbMetaData",function(n,c){k(n.IDBStore,t.key,!0).then(function(c){r=c,o.changedSince===!0?(r.remoteOriginal=o.record,_(n,r,"INTERNAL")):r.deleted?n.IDBStore.delete(t.key):(r.changedSinceSync=0,r.version=t.newVersion,delete r.remoteOriginal,d(t.newKey)||(r.key=t.newKey,n.IDBStore.delete(t.key)),_(n,r,"INTERNAL")),delete e.recordsSentToRemote[t.key]}).then(function(){M(c,t.storeName,t.timestamp)})}).then(function(){e.stores[t.storeName].emit("synced",t.key,r),e.recordsToSync.add(-1)})},reject:function(e,n,t){if(!h(t.key))throw new Error("Reject message recieved from remote without key property");var r=s(t.storeName)?e.stores[t.storeName].handleReject:e.handleReject;if(!f(r))throw new Error("Reject message recieved from remote but no reject handler is supplied");e.stores[t.storeName].get(t.key).then(function(e){return r(e,t)}).then(function(n){n?B(e,t.storeName,n):e.recordsToSync.add(-1)})}};tn.prototype.connect=function(){var e=this;return e.then(function(){return K(e).then(function(){})})},tn.prototype.disconnect=function(){this.ws&&(this.ws.close(),this.wsPromise=null)},tn.prototype.send=function(e){return K(this).then(function(n){n.send(e)})},tn.prototype.pushToRemote=function(){return J(this,arguments).then(F).then(Z)},tn.prototype.pullFromRemote=function(){return J(this,arguments).then(P).then(Z)},tn.prototype.sync=function(e,n){1!==arguments.length||X(e)||(n=e),e=s(e)?[e]:X(e)?e:[];var t=a(n)&&n.continuously===!0;return V(this,t,e)},e.open=function(e){return new tn(e)},e.patch=z.patch,e.diff=z.diff,e.open=function(e){return new tn(e)}}(this.syncedDB={});